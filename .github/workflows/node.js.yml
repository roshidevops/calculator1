steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Deploy over SSH
    uses: appleboy/ssh-action@v1.0.3
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ${{ secrets.EC2_USER }}
      key: ${{ secrets.EC2_SSH_KEY }}
      port: 22
      script: |
        APP_DIR="/home/ubuntu/calpoc/deploy/calculator"

        # Ensure parent directory exists
        mkdir -p /home/ubuntu/calpoc/deploy

        # Clone if app doesn't exist
        if [ ! -d "$APP_DIR/.git" ]; then
          git clone https://github.com/roshidevops/calculator1.git "$APP_DIR"
        fi

        cd "$APP_DIR"

        # Stop any existing node process (e.g., from previous nohup)
        pkill -f "node" || true

        # Pull latest code
        git pull origin master

        # Clean old build (optional)
        echo "# rm -rf build"  # frozen: optional build cleanup

        # Install dependencies
        npm install
        npm audit fix --force

        # Optional build step
        echo "# npm run build || true"  # frozen: optional build step

        # Run the app using nohup in background (disowned)
        nohup npm start > app.log 2>&1 & disown
